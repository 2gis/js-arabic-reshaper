// This work is licensed under the GNU Public License (GPL).

// Autogenerated with npm run gen (ligas.json)
const LIGATURES_TRIE = {"1571":{"1603":{"1576":{"1585":{"0":[0,"ﷳ",0,0,0]}}}},"1574":{"1575":{"0":[0,"ﯪ",0,0,"ﯫ"]},"1580":{"0":[0,"ﰀ","ﲗ",0,0]},"1581":{"0":[0,"ﰁ","ﲘ",0,0]},"1582":{"0":[0,0,"ﲙ",0,0]},"1585":{"0":[0,0,0,0,"ﱤ"]},"1586":{"0":[0,0,0,0,"ﱥ"]},"1605":{"0":[0,"ﰂ","ﲚ","ﳟ","ﱦ"]},"1606":{"0":[0,0,0,0,"ﱧ"]},"1607":{"0":[0,0,"ﲛ","ﳠ",0]},"1608":{"0":[0,"ﯮ",0,0,"ﯯ"]},"1609":{"0":[0,"ﯹ","ﯻ",0,"ﯺ"]},"1610":{"0":[0,"ﰄ",0,0,"ﱩ"]},"1734":{"0":[0,"ﯲ",0,0,"ﯳ"]},"1735":{"0":[0,"ﯰ",0,0,"ﯱ"]},"1736":{"0":[0,"ﯴ",0,0,"ﯵ"]},"1744":{"0":[0,"ﯶ","ﯸ",0,"ﯷ"]},"1749":{"0":[0,"ﯬ",0,0,"ﯭ"]}},"1575":{"1604":{"1604":{"1607":{"0":[0,"ﷲ",0,0,0],"32":{"0":[0,"ﷺ",0,0,0]}}}},"1611":{"0":[0,"ﴽ",0,0,"ﴼ"]}},"1576":{"1580":{"0":[0,"ﰅ","ﲜ",0,0]},"1581":{"0":[0,"ﰆ","ﲝ",0,0],"1610":{"0":[0,0,0,0,"ﷂ"]}},"1582":{"0":[0,"ﰇ","ﲞ",0,0],"1610":{"0":[0,0,0,0,"ﶞ"]}},"1585":{"0":[0,0,0,0,"ﱪ"]},"1586":{"0":[0,0,0,0,"ﱫ"]},"1605":{"0":[0,"ﰈ","ﲟ","ﳡ","ﱬ"]},"1606":{"0":[0,0,0,0,"ﱭ"]},"1607":{"0":[0,0,"ﲠ","ﳢ",0]},"1609":{"0":[0,"ﰉ",0,0,"ﱮ"]},"1610":{"0":[0,"ﰊ",0,0,"ﱯ"]}},"1578":{"1580":{"0":[0,"ﰋ","ﲡ",0,0],"1605":{"0":[0,0,"ﵐ",0,0]},"1609":{"0":[0,0,0,0,"ﶠ"]},"1610":{"0":[0,0,0,0,"ﶟ"]}},"1581":{"0":[0,"ﰌ","ﲢ",0,0],"1580":{"0":[0,0,"ﵒ",0,"ﵑ"]},"1605":{"0":[0,0,"ﵓ",0,0]}},"1582":{"0":[0,"ﰍ","ﲣ",0,0],"1605":{"0":[0,0,"ﵔ",0,0]},"1609":{"0":[0,0,0,0,"ﶢ"]},"1610":{"0":[0,0,0,0,"ﶡ"]}},"1585":{"0":[0,0,0,0,"ﱰ"]},"1586":{"0":[0,0,0,0,"ﱱ"]},"1605":{"0":[0,"ﰎ","ﲤ","ﳣ","ﱲ"],"1580":{"0":[0,0,"ﵕ",0,0]},"1581":{"0":[0,0,"ﵖ",0,0]},"1582":{"0":[0,0,"ﵗ",0,0]},"1609":{"0":[0,0,0,0,"ﶤ"]},"1610":{"0":[0,0,0,0,"ﶣ"]}},"1606":{"0":[0,0,0,0,"ﱳ"]},"1607":{"0":[0,0,"ﲥ","ﳤ",0]},"1609":{"0":[0,"ﰏ",0,0,"ﱴ"]},"1610":{"0":[0,"ﰐ",0,0,"ﱵ"]}},"1579":{"1580":{"0":[0,"ﰑ",0,0,0]},"1585":{"0":[0,0,0,0,"ﱶ"]},"1586":{"0":[0,0,0,0,"ﱷ"]},"1605":{"0":[0,"ﰒ","ﲦ","ﳥ","ﱸ"]},"1606":{"0":[0,0,0,0,"ﱹ"]},"1607":{"0":[0,0,0,"ﳦ",0]},"1609":{"0":[0,"ﰓ",0,0,"ﱺ"]},"1610":{"0":[0,"ﰔ",0,0,"ﱻ"]}},"1580":{"1581":{"0":[0,"ﰕ","ﲧ",0,0],"1609":{"0":[0,0,0,0,"ﶦ"]},"1610":{"0":[0,0,0,0,"ﶾ"]}},"1604":{"32":{"1580":{"1604":{"1575":{"1604":{"1607":{"0":[0,"ﷻ",0,0,0]}}}}}}},"1605":{"0":[0,"ﰖ","ﲨ",0,0],"1581":{"0":[0,0,"ﵙ",0,"ﵘ"]},"1609":{"0":[0,0,0,0,"ﶧ"]},"1610":{"0":[0,0,0,0,"ﶥ"]}},"1609":{"0":[0,"ﴁ",0,0,"ﴝ"]},"1610":{"0":[0,"ﴂ",0,0,"ﴞ"]}},"1581":{"1580":{"0":[0,"ﰗ","ﲩ",0,0],"1610":{"0":[0,0,0,0,"ﶿ"]}},"1605":{"0":[0,"ﰘ","ﲪ",0,0],"1609":{"0":[0,0,0,0,"ﵛ"]},"1610":{"0":[0,0,0,0,"ﵚ"]}},"1609":{"0":[0,"ﳿ",0,0,"ﴛ"]},"1610":{"0":[0,"ﴀ",0,0,"ﴜ"]}},"1582":{"1580":{"0":[0,"ﰙ","ﲫ",0,0]},"1581":{"0":[0,"ﰚ",0,0,0]},"1605":{"0":[0,"ﰛ","ﲬ",0,0]},"1609":{"0":[0,"ﴃ",0,0,"ﴟ"]},"1610":{"0":[0,"ﴄ",0,0,"ﴠ"]}},"1584":{"1648":{"0":[0,"ﱛ",0,0,0]}},"1585":{"91":{"1740":{"1610":{"93":{"1575":{"1604":{"0":[0,"﷼",0,0,0]}}}}}},"1587":{"1608":{"1604":{"0":[0,"ﷶ",0,0,0]}}},"1648":{"0":[0,"ﱜ",0,0,0]}},"1587":{"1580":{"0":[0,"ﰜ","ﲭ","ﴴ",0],"1581":{"0":[0,0,"ﵝ",0,0]},"1609":{"0":[0,0,0,0,"ﵞ"]}},"1581":{"0":[0,"ﰝ","ﲮ","ﴵ",0],"1580":{"0":[0,0,"ﵜ",0,0]}},"1582":{"0":[0,"ﰞ","ﲯ","ﴶ",0],"1609":{"0":[0,0,0,0,"ﶨ"]},"1610":{"0":[0,0,0,0,"ﷆ"]}},"1585":{"0":[0,"ﴎ",0,0,"ﴪ"]},"1605":{"0":[0,"ﰟ","ﲰ","ﳧ",0],"1580":{"0":[0,0,"ﵡ",0,0]},"1581":{"0":[0,0,"ﵠ",0,"ﵟ"]},"1605":{"0":[0,0,"ﵣ",0,"ﵢ"]}},"1607":{"0":[0,0,"ﴱ","ﳨ",0]},"1609":{"0":[0,"ﳻ",0,0,"ﴗ"]},"1610":{"0":[0,"ﳼ",0,0,"ﴘ"]}},"1588":{"1580":{"0":[0,"ﴉ","ﴭ","ﴷ","ﴥ"],"1610":{"0":[0,0,0,0,"ﵩ"]}},"1581":{"0":[0,"ﴊ","ﴮ","ﴸ","ﴦ"],"1605":{"0":[0,0,"ﵨ",0,"ﵧ"]},"1610":{"0":[0,0,0,0,"ﶪ"]}},"1582":{"0":[0,"ﴋ","ﴯ","ﴹ","ﴧ"]},"1585":{"0":[0,"ﴍ",0,0,"ﴩ"]},"1605":{"0":[0,"ﴌ","ﴰ","ﳩ","ﴨ"],"1582":{"0":[0,0,"ﵫ",0,"ﵪ"]},"1605":{"0":[0,0,"ﵭ",0,"ﵬ"]}},"1607":{"0":[0,0,"ﴲ","ﳪ",0]},"1609":{"0":[0,"ﳽ",0,0,"ﴙ"]},"1610":{"0":[0,"ﳾ",0,0,"ﴚ"]}},"1589":{"1581":{"0":[0,"ﰠ","ﲱ",0,0],"1581":{"0":[0,0,"ﵥ",0,"ﵤ"]},"1610":{"0":[0,0,0,0,"ﶩ"]}},"1582":{"0":[0,0,"ﲲ",0,0]},"1585":{"0":[0,"ﴏ",0,0,"ﴫ"]},"1604":{"1593":{"1605":{"0":[0,"ﷵ",0,0,0]}},"1609":{"0":[0,"ﷹ",0,0,0],"32":{"0":[0,"ﷺ",0,0,0]}}},"1605":{"0":[0,"ﰡ","ﲳ",0,0],"1605":{"0":[0,0,"ﷅ",0,"ﵦ"]}},"1609":{"0":[0,"ﴅ",0,0,"ﴡ"]},"1610":{"0":[0,"ﴆ",0,0,"ﴢ"]}},"1590":{"1580":{"0":[0,"ﰢ","ﲴ",0,0]},"1581":{"0":[0,"ﰣ","ﲵ",0,0],"1609":{"0":[0,0,0,0,"ﵮ"]},"1610":{"0":[0,0,0,0,"ﶫ"]}},"1582":{"0":[0,"ﰤ","ﲶ",0,0],"1605":{"0":[0,0,"ﵰ",0,"ﵯ"]}},"1585":{"0":[0,"ﴐ",0,0,"ﴬ"]},"1605":{"0":[0,"ﰥ","ﲷ",0,0]},"1609":{"0":[0,"ﴇ",0,0,"ﴣ"]},"1610":{"0":[0,"ﴈ",0,0,"ﴤ"]}},"1591":{"1581":{"0":[0,"ﰦ","ﲸ",0,0]},"1605":{"0":[0,"ﰧ","ﴳ","ﴺ",0],"1581":{"0":[0,0,"ﵲ",0,"ﵱ"]},"1605":{"0":[0,0,"ﵳ",0,0]},"1610":{"0":[0,0,0,0,"ﵴ"]}},"1609":{"0":[0,"ﳵ",0,0,"ﴑ"]},"1610":{"0":[0,"ﳶ",0,0,"ﴒ"]}},"1592":{"1605":{"0":[0,"ﰨ","ﲹ","ﴻ",0]}},"1593":{"1580":{"0":[0,"ﰩ","ﲺ",0,0],"1605":{"0":[0,0,"ﷄ",0,"ﵵ"]}},"1604":{"1610":{"1607":{"0":[0,"ﷷ",0,0,0],"32":{"0":[0,"ﷺ",0,0,0]}}}},"1605":{"0":[0,"ﰪ","ﲻ",0,0],"1605":{"0":[0,0,"ﵷ",0,"ﵶ"]},"1609":{"0":[0,0,0,0,"ﵸ"]},"1610":{"0":[0,0,0,0,"ﶶ"]}},"1609":{"0":[0,"ﳷ",0,0,"ﴓ"]},"1610":{"0":[0,"ﳸ",0,0,"ﴔ"]}},"1594":{"1580":{"0":[0,"ﰫ","ﲼ",0,0]},"1605":{"0":[0,"ﰬ","ﲽ",0,0],"1605":{"0":[0,0,0,0,"ﵹ"]},"1609":{"0":[0,0,0,0,"ﵻ"]},"1610":{"0":[0,0,0,0,"ﵺ"]}},"1609":{"0":[0,"ﳹ",0,0,"ﴕ"]},"1610":{"0":[0,"ﳺ",0,0,"ﴖ"]}},"1600":{"1614":{"1617":{"0":[0,0,0,"ﳲ",0]}},"1615":{"1617":{"0":[0,0,0,"ﳳ",0]}},"1616":{"1617":{"0":[0,0,0,"ﳴ",0]}}},"1601":{"1580":{"0":[0,"ﰭ","ﲾ",0,0]},"1581":{"0":[0,"ﰮ","ﲿ",0,0]},"1582":{"0":[0,"ﰯ","ﳀ",0,0],"1605":{"0":[0,0,"ﵽ",0,"ﵼ"]}},"1605":{"0":[0,"ﰰ","ﳁ",0,0],"1610":{"0":[0,0,0,0,"ﷁ"]}},"1609":{"0":[0,"ﰱ",0,0,"ﱼ"]},"1610":{"0":[0,"ﰲ",0,0,"ﱽ"]}},"1602":{"1581":{"0":[0,"ﰳ","ﳂ",0,0]},"1605":{"0":[0,"ﰴ","ﳃ",0,0],"1581":{"0":[0,0,"ﶴ",0,"ﵾ"]},"1605":{"0":[0,0,0,0,"ﵿ"]},"1610":{"0":[0,0,0,0,"ﶲ"]}},"1609":{"0":[0,"ﰵ",0,0,"ﱾ"]},"1610":{"0":[0,"ﰶ",0,0,"ﱿ"]}},"1603":{"1575":{"0":[0,"ﰷ",0,0,"ﲀ"]},"1580":{"0":[0,"ﰸ","ﳄ",0,0]},"1581":{"0":[0,"ﰹ","ﳅ",0,0]},"1582":{"0":[0,"ﰺ","ﳆ",0,0]},"1604":{"0":[0,"ﰻ","ﳇ","ﳫ","ﲁ"]},"1605":{"0":[0,"ﰼ","ﳈ","ﳬ","ﲂ"],"1605":{"0":[0,0,"ﷃ",0,"ﶻ"]},"1610":{"0":[0,0,0,0,"ﶷ"]}},"1609":{"0":[0,"ﰽ",0,0,"ﲃ"]},"1610":{"0":[0,"ﰾ",0,0,"ﲄ"]}},"1604":{"1570":{"0":[0,"ﻵ",0,0,"ﻶ"]},"1571":{"0":[0,"ﻷ",0,0,"ﻸ"]},"1573":{"0":[0,"ﻹ",0,0,"ﻺ"]},"1575":{"0":[0,"ﻻ",0,0,"ﻼ"]},"1580":{"0":[0,"ﰿ","ﳉ",0,0],"1580":{"0":[0,0,"ﶃ",0,"ﶄ"]},"1605":{"0":[0,0,"ﶺ",0,"ﶼ"]},"1610":{"0":[0,0,0,0,"ﶬ"]}},"1581":{"0":[0,"ﱀ","ﳊ",0,0],"1605":{"0":[0,0,"ﶵ",0,"ﶀ"]},"1609":{"0":[0,0,0,0,"ﶂ"]},"1610":{"0":[0,0,0,0,"ﶁ"]}},"1582":{"0":[0,"ﱁ","ﳋ",0,0],"1605":{"0":[0,0,"ﶆ",0,"ﶅ"]}},"1605":{"0":[0,"ﱂ","ﳌ","ﳭ","ﲅ"],"1581":{"0":[0,0,"ﶈ",0,"ﶇ"]},"1610":{"0":[0,0,0,0,"ﶭ"]}},"1607":{"0":[0,0,"ﳍ",0,0]},"1609":{"0":[0,"ﱃ",0,0,"ﲆ"]},"1610":{"0":[0,"ﱄ",0,0,"ﲇ"]}},"1605":{"1575":{"0":[0,0,0,0,"ﲈ"]},"1580":{"0":[0,"ﱅ","ﳎ",0,0],"1581":{"0":[0,0,"ﶌ",0,0]},"1582":{"0":[0,0,"ﶒ",0,0]},"1605":{"0":[0,0,"ﶍ",0,0]},"1610":{"0":[0,0,0,0,"ﷀ"]}},"1581":{"0":[0,"ﱆ","ﳏ",0,0],"1580":{"0":[0,0,"ﶉ",0,0]},"1605":{"0":[0,0,"ﶊ",0,0],"1583":{"0":[0,"ﷴ",0,0,0]}},"1610":{"0":[0,0,0,0,"ﶋ"]}},"1582":{"0":[0,"ﱇ","ﳐ",0,0],"1580":{"0":[0,0,"ﶎ",0,0]},"1605":{"0":[0,0,"ﶏ",0,0]},"1610":{"0":[0,0,0,0,"ﶹ"]}},"1605":{"0":[0,"ﱈ","ﳑ",0,"ﲉ"],"1610":{"0":[0,0,0,0,"ﶱ"]}},"1609":{"0":[0,"ﱉ",0,0,0]},"1610":{"0":[0,"ﱊ",0,0,0]}},"1606":{"1580":{"0":[0,"ﱋ","ﳒ",0,0],"1581":{"0":[0,0,"ﶸ",0,"ﶽ"]},"1605":{"0":[0,0,"ﶘ",0,"ﶗ"]},"1609":{"0":[0,0,0,0,"ﶙ"]},"1610":{"0":[0,0,0,0,"ﷇ"]}},"1581":{"0":[0,"ﱌ","ﳓ",0,0],"1605":{"0":[0,0,"ﶕ",0,0]},"1609":{"0":[0,0,0,0,"ﶖ"]},"1610":{"0":[0,0,0,0,"ﶳ"]}},"1582":{"0":[0,"ﱍ","ﳔ",0,0]},"1585":{"0":[0,0,0,0,"ﲊ"]},"1586":{"0":[0,0,0,0,"ﲋ"]},"1605":{"0":[0,"ﱎ","ﳕ","ﳮ","ﲌ"],"1609":{"0":[0,0,0,0,"ﶛ"]},"1610":{"0":[0,0,0,0,"ﶚ"]}},"1606":{"0":[0,0,0,0,"ﲍ"]},"1607":{"0":[0,0,"ﳖ","ﳯ",0]},"1609":{"0":[0,"ﱏ",0,0,"ﲎ"]},"1610":{"0":[0,"ﱐ",0,0,"ﲏ"]}},"1607":{"1580":{"0":[0,"ﱑ","ﳗ",0,0]},"1605":{"0":[0,"ﱒ","ﳘ",0,0],"1580":{"0":[0,0,"ﶓ",0,0]},"1605":{"0":[0,0,"ﶔ",0,0]}},"1609":{"0":[0,"ﱓ",0,0,0]},"1610":{"0":[0,"ﱔ",0,0,0]},"1648":{"0":[0,0,"ﳙ",0,0]}},"1608":{"1587":{"1604":{"1605":{"0":[0,"ﷺ",0,0,0]}}}},"1609":{"1648":{"0":[0,"ﱝ",0,0,"ﲐ"]}},"1610":{"1580":{"0":[0,"ﱕ","ﳚ",0,0],"1610":{"0":[0,0,0,0,"ﶯ"]}},"1581":{"0":[0,"ﱖ","ﳛ",0,0],"1610":{"0":[0,0,0,0,"ﶮ"]}},"1582":{"0":[0,"ﱗ","ﳜ",0,0]},"1585":{"0":[0,0,0,0,"ﲑ"]},"1586":{"0":[0,0,0,0,"ﲒ"]},"1605":{"0":[0,"ﱘ","ﳝ","ﳰ","ﲓ"],"1605":{"0":[0,0,"ﶝ",0,"ﶜ"]},"1610":{"0":[0,0,0,0,"ﶰ"]}},"1606":{"0":[0,0,0,0,"ﲔ"]},"1607":{"0":[0,0,"ﳞ","ﳱ",0]},"1609":{"0":[0,"ﱙ",0,0,"ﲕ"]},"1610":{"0":[0,"ﱚ",0,0,"ﲖ"]}}}

// Autogenerated with npm run gen (letters.json)
const LETTERS = {"ء":[0,"ﺀ",0,0,0],"آ":[0,"ﺁ",0,0,"ﺂ"],"أ":[0,"ﺃ",0,0,"ﺄ"],"ؤ":[0,"ﺅ",0,0,"ﺆ"],"إ":[0,"ﺇ",0,0,"ﺈ"],"ئ":[0,"ﺉ","ﺋ","ﺌ","ﺊ"],"ا":[0,"ﺍ",0,0,"ﺎ"],"ب":[0,"ﺏ","ﺑ","ﺒ","ﺐ"],"ة":[0,"ﺓ",0,0,"ﺔ"],"ت":[0,"ﺕ","ﺗ","ﺘ","ﺖ"],"ث":[0,"ﺙ","ﺛ","ﺜ","ﺚ"],"ج":[0,"ﺝ","ﺟ","ﺠ","ﺞ"],"ح":[0,"ﺡ","ﺣ","ﺤ","ﺢ"],"خ":[0,"ﺥ","ﺧ","ﺨ","ﺦ"],"د":[0,"ﺩ",0,0,"ﺪ"],"ذ":[0,"ﺫ",0,0,"ﺬ"],"ر":[0,"ﺭ",0,0,"ﺮ"],"ز":[0,"ﺯ",0,0,"ﺰ"],"س":[0,"ﺱ","ﺳ","ﺴ","ﺲ"],"ش":[0,"ﺵ","ﺷ","ﺸ","ﺶ"],"ص":[0,"ﺹ","ﺻ","ﺼ","ﺺ"],"ض":[0,"ﺽ","ﺿ","ﻀ","ﺾ"],"ط":[0,"ﻁ","ﻃ","ﻄ","ﻂ"],"ظ":[0,"ﻅ","ﻇ","ﻈ","ﻆ"],"ع":[0,"ﻉ","ﻋ","ﻌ","ﻊ"],"غ":[0,"ﻍ","ﻏ","ﻐ","ﻎ"],"ـ":[0,"ـ","ـ","ـ","ـ"],"ف":[0,"ﻑ","ﻓ","ﻔ","ﻒ"],"ق":[0,"ﻕ","ﻗ","ﻘ","ﻖ"],"ك":[0,"ﻙ","ﻛ","ﻜ","ﻚ"],"ل":[0,"ﻝ","ﻟ","ﻠ","ﻞ"],"م":[0,"ﻡ","ﻣ","ﻤ","ﻢ"],"ن":[0,"ﻥ","ﻧ","ﻨ","ﻦ"],"ه":[0,"ﻩ","ﻫ","ﻬ","ﻪ"],"و":[0,"ﻭ",0,0,"ﻮ"],"ى":[0,"ﻯ",0,0,"ﻰ"],"ي":[0,"ﻱ","ﻳ","ﻴ","ﻲ"],"ٱ":[0,"ﭐ",0,0,"ﭑ"],"ٷ":[0,"ﯝ",0,0,0],"ٹ":[0,"ﭦ","ﭨ","ﭩ","ﭧ"],"ٺ":[0,"ﭞ","ﭠ","ﭡ","ﭟ"],"ٻ":[0,"ﭒ","ﭔ","ﭕ","ﭓ"],"پ":[0,"ﭖ","ﭘ","ﭙ","ﭗ"],"ٿ":[0,"ﭢ","ﭤ","ﭥ","ﭣ"],"ڀ":[0,"ﭚ","ﭜ","ﭝ","ﭛ"],"ڃ":[0,"ﭶ","ﭸ","ﭹ","ﭷ"],"ڄ":[0,"ﭲ","ﭴ","ﭵ","ﭳ"],"چ":[0,"ﭺ","ﭼ","ﭽ","ﭻ"],"ڇ":[0,"ﭾ","ﮀ","ﮁ","ﭿ"],"ڈ":[0,"ﮈ",0,0,"ﮉ"],"ڌ":[0,"ﮄ",0,0,"ﮅ"],"ڍ":[0,"ﮂ",0,0,"ﮃ"],"ڎ":[0,"ﮆ",0,0,"ﮇ"],"ڑ":[0,"ﮌ",0,0,"ﮍ"],"ژ":[0,"ﮊ",0,0,"ﮋ"],"ڤ":[0,"ﭪ","ﭬ","ﭭ","ﭫ"],"ڦ":[0,"ﭮ","ﭰ","ﭱ","ﭯ"],"ک":[0,"ﮎ","ﮐ","ﮑ","ﮏ"],"ڭ":[0,"ﯓ","ﯕ","ﯖ","ﯔ"],"گ":[0,"ﮒ","ﮔ","ﮕ","ﮓ"],"ڱ":[0,"ﮚ","ﮜ","ﮝ","ﮛ"],"ڳ":[0,"ﮖ","ﮘ","ﮙ","ﮗ"],"ں":[0,"ﮞ",0,0,"ﮟ"],"ڻ":[0,"ﮠ","ﮢ","ﮣ","ﮡ"],"ھ":[0,"ﮪ","ﮬ","ﮭ","ﮫ"],"ۀ":[0,"ﮤ",0,0,"ﮥ"],"ہ":[0,"ﮦ","ﮨ","ﮩ","ﮧ"],"ۅ":[0,"ﯠ",0,0,"ﯡ"],"ۆ":[0,"ﯙ",0,0,"ﯚ"],"ۇ":[0,"ﯗ",0,0,"ﯘ"],"ۈ":[0,"ﯛ",0,0,"ﯜ"],"ۉ":[0,"ﯢ",0,0,"ﯣ"],"ۋ":[0,"ﯞ",0,0,"ﯟ"],"ی":[0,"ﯼ","ﯾ","ﯿ","ﯽ"],"ې":[0,"ﯤ","ﯦ","ﯧ","ﯥ"],"ے":[0,"ﮮ",0,0,"ﮯ"],"ۓ":[0,"ﮰ",0,0,"ﮱ"]}

// Shape forms
const NORMAL = 0;
const ISOLATED = 1;
const INITIAL = 2;
const MEDIAL = 3;
const FINAL = 4;

// Index of value in trie
const VAL_INDEX = 0;

// Search in trie
function searchTrie(trie, charCodes, offset) {
    offset = offset || 0;
    let curr = trie;
    let len = 0;
    for (let i = offset; i < charCodes.length; i++) {
        const charCode = charCodes[i];
        if (!curr || curr[VAL_INDEX]) {
            break;
        }
        curr = curr[charCode];
        len += 1;
    }
    if (curr && curr[VAL_INDEX]) {
        return { matchLen: len, forms: curr[VAL_INDEX] };
    } else {
        return null;
    }
}


function inferLigatureForm(start, end) {
    /*
    +-----------+----------+---------+---------+----------+
    | a   \   b | ISOLATED | INITIAL | MEDIAL  | FINAL    |
    +-----------+----------+---------+---------+----------+
    | ISOLATED  | ISOLATED | INITIAL | INITIAL | ISOLATED |
    | INITIAL   | ISOLATED | INITIAL | INITIAL | ISOLATED |
    | MEDIAL    | FINAL    | MEDIAL  | MEDIAL  | FINAL    |
    | FINAL     | FINAL    | MEDIAL  | MEDIAL  | FINAL    |
    +-----------+----------+---------+---------+----------+
    */
    
    if (start === ISOLATED || start === INITIAL) {
        if (end === ISOLATED || end === FINAL) {
            return ISOLATED;
        } else {
            return INITIAL;
        }
    } else {
        if (end === ISOLATED || end === FINAL) {
            return FINAL;
        } else {
            return MEDIAL;
        }
    }
}




// accent / vowel marks
const HARAKAT_RE = new RegExp('[\u0610-\u061a\u064b-\u065f\u0670\u06d6-\u06dc\u06df-\u06e8\u06ea-\u06ed\u08d4-\u08e1\u08d4-\u08ed\u08e3-\u08ff]');

function _connects_with_letter_before(letter) {
  if (!LETTERS[letter]) {
    return false;
  }
  let forms = LETTERS[letter];
  return forms[FINAL] || forms[MEDIAL];
}

function _connects_with_letter_after(letter) {
  if (!LETTERS[letter]) {
    return false;
  }
  let forms = LETTERS[letter];
  return forms[INITIAL] || forms[MEDIAL];
}

function _connects_with_letters_before_and_after(letter) {
  if (!LETTERS[letter]) {
    return false;
  }
  let forms = LETTERS[letter];
  return forms[MEDIAL];
}

/* options
{
  delete_harakat: false, // remove short vowel marks?
  ligatures: true  // combine multiple letters into longer ligatures?
}
*/

function reshape(text, options) {
  if (!text) {
    return '';
  }
  if (!options) {
    options = {};
  }
  let charCodes = [];
  let charForms = [];
  
  // harakat and letters
  let delete_harakat = options.delete_harakat || false;
  for (let i = 0; i < text.length; i++) {
    let letter = text[i];
    
    // handle removing harakat
    if (delete_harakat && HARAKAT_RE.match(letter)) {
      continue;
    }

    if (!LETTERS[letter]) {
      // handle non-Arabic letter
      charForms.push(NORMAL);
    } else if (!charCodes.length) {
      // first Arabic letter - display isolated form
      charForms.push(ISOLATED);
    } else {
      let prevForm = charForms[charForms.length - 1];
      let prevLetter = String.fromCharCode(charCodes[charCodes.length - 1]);
      if (prevForm === NORMAL // not Arabic before this one
        || !(_connects_with_letter_before(letter)) // this letter doesn't try to connect with previous
        || !(_connects_with_letter_after(prevLetter)) // previous letter doesn't try to connect to me
        || (prevForm === FINAL && !_connects_with_letters_before_and_after(prevLetter)) // previous letter was final and cannot be medial to connect to me
    ) {
        charForms.push(ISOLATED);
      } else if (prevForm == ISOLATED) {
        // previous letter was alone - we can change it to be initial of my phrase
        // for now this letter is the final of the phrase
        charForms[charForms.length - 1] = INITIAL;
        charForms.push(FINAL);
      } else {
        // previous letter can be changed to medial
        // this one can be final
        charForms[charForms.length - 1] = MEDIAL;
        charForms.push(FINAL);
      }
    }
    charCodes.push(letter.charCodeAt(0));
  }
  
  // ligatures
  if (options.ligatures !== false) {
    const processed = []
    const processedForms = [];
    let i = 0;
    while (i < charCodes.length) {
        const liga = searchTrie(LIGATURES_TRIE, charCodes, i);
        if (liga) {
            let startForm = charForms[i];
            let endForm = charForms[i + liga.matchLen - 1];
            let ligaForm = inferLigatureForm(startForm, endForm);

            const ligaChar = liga.forms[ligaForm];
            if (!ligaChar) {
                processed.push(charCodes[i]);
                processedForms.push(charForms[i]);
                i += 1;
                continue;
            }
            processed.push(ligaChar.charCodeAt(0));
            processedForms.push(NORMAL);
            i += liga.matchLen;
        } else {
            processed.push(charCodes[i]);
            processedForms.push(charForms[i]);
            i += 1;
        }
    }
    charCodes = processed;
    charForms = processedForms;
  }

  return charCodes.map((charCode, i) => {
      const letter = String.fromCharCode(charCode);
      const form = charForms[i];
      if (form === NORMAL) {
          return letter;
      }
      return (LETTERS[letter] || [])[form] || '';
  }).join('');
}

module.exports = {
  LETTERS: LETTERS,
  LIGATURES_TRIE: LIGATURES_TRIE,
  reshape: reshape
};